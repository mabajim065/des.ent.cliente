<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Difícil 4 - Waterfall</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 8px; max-width: 700px; margin: 0 auto; }
        button { background: #fd7e14; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        #logs { background: #222; color: #0f0; padding: 15px; margin-top: 15px; border-radius: 5px; height: 200px; overflow-y:auto; font-family: monospace;}
    </style>
</head>
<body>
    <div class="box">
        <h2>Ejercicio 4: Cadena de Procesos Asíncronos</h2>
        <p><strong>Misión:</strong> Simula un proceso de login + obtención de datos + guardado.<br>
        Cada paso tarda 1 segundo. El paso 2 necesita el ID del paso 1. El paso 3 necesita los datos del paso 2.</p>
        
        <button onclick="iniciarSistema()">Iniciar Secuencia</button>
        <div id="logs">Esperando...</div>
    </div>

    <script>
        const log = (m) => document.getElementById('logs').innerHTML += `> ${m}<br>`;

        // --- SOLUCIÓN (Callback Hell simulado pero controlado) ---
        
        // Función 1: Login
        function autenticarUsuario(user, callback) {
            log(`Autenticando a ${user}...`);
            setTimeout(() => {
                const idUsuario = 999; // ID simulado
                log(`Usuario autenticado. ID generado: ${idUsuario}`);
                callback(idUsuario);
            }, 1000);
        }

        // Función 2: Obtener Datos (Necesita ID)
        function descargarPerfil(id, callback) {
            log(`Buscando perfil para ID ${id}...`);
            setTimeout(() => {
                const perfil = { nombre: "Carlos", rol: "Admin" };
                log(`Perfil descargado: ${JSON.stringify(perfil)}`);
                callback(perfil);
            }, 1000);
        }

        // Función 3: Guardar Log (Necesita Perfil)
        function guardarAcceso(perfil, callback) {
            log(`Registrando acceso de ${perfil.nombre}...`);
            setTimeout(() => {
                log("Registro guardado en base de datos.");
                callback(true);
            }, 1000);
        }

        // --- ORQUESTADOR ---
        function iniciarSistema() {
            document.getElementById('logs').innerHTML = "";
            
            // Ejecución en cascada (Waterfall)
            autenticarUsuario("AdminUser", (id) => {
                
                descargarPerfil(id, (perfil) => {
                    
                    guardarAcceso(perfil, (exito) => {
                        log("----- PROCESO FINALIZADO CON ÉXITO -----");
                    });

                });

            });
        }
    </script>
</body>
</html>